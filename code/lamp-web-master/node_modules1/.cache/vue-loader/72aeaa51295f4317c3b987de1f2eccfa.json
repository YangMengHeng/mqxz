{"remainingRequest":"E:\\项目\\lamp-web-master\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!E:\\项目\\lamp-web-master\\src\\views\\lamp\\resources\\sms\\edit.vue?vue&type=script&lang=js&","dependencies":[{"path":"E:\\项目\\lamp-web-master\\src\\views\\lamp\\resources\\sms\\edit.vue","mtime":1679380940000},{"path":"E:\\项目\\lamp-web-master\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1686711136315},{"path":"E:\\项目\\lamp-web-master\\node_modules\\babel-loader\\lib\\index.js","mtime":1686711137609},{"path":"E:\\项目\\lamp-web-master\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1686711136315},{"path":"E:\\项目\\lamp-web-master\\node_modules\\vue-loader\\lib\\index.js","mtime":1686711137115}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\nimport smsTemplateApi from '@/api/SmsTemplate.js'\nimport smsTaskApi from '@/api/SmsTask.js'\nimport { validMobile } from '@/utils/my-validate'\nimport SendStatusIndex from './sendStatusIndex'\n\nexport default {\n  name: 'SmsTaskEdit',\n  components: { SendStatusIndex },\n  filters: {\n    statusFilter (status) {\n      const map = {\n        WAITING: 'danger',\n        SUCCESS: 'success',\n        FAIL: 'error'\n      }\n      return map[status] || 'success'\n    }\n  },\n  props: {\n\n  },\n  data () {\n    return {\n      dialog: {\n        isVisible: false\n      },\n      type: 'add',\n      smsTask: this.initSmsTask(),\n      smsTemplateList: [],\n      telNumList: [],\n      telNumVisible: false,\n      telNum: '',\n      timing: false,\n      disabled: false,\n      smsTemplate: '',\n      content: '',\n      rules: {\n        topic: [\n          { required: true, message: this.$t('rules.require'), trigger: 'blur' },\n          { min: 1, max: 255, message: this.$t('rules.range4to10'), trigger: 'blur' }\n        ],\n        templateId: { required: true, message: this.$t('rules.require'), trigger: 'blur' },\n        sendTime: {\n          validator: (rule, value, callback) => {\n            const vm = this\n            if (vm.timing) {\n              if (vm.smsTask.sendTime) {\n                callback()\n              } else {\n                callback('请选择发送日期')\n              }\n            } else {\n              callback()\n            }\n          }, trigger: 'change'\n        }\n      },\n      pickerOptions: {\n        shortcuts: [{\n          text: '一小时后',\n          onClick (picker) {\n            const date = new Date();\n            date.setTime(date.getTime() + 3600 * 1000 * 1)\n            picker.$emit('pick', date)\n          }\n        }, {\n          text: '明天',\n          onClick (picker) {\n            const date = new Date();\n            date.setTime(date.getTime() + 3600 * 1000 * 24)\n            picker.$emit('pick', date);\n          }\n        }, {\n          text: '一周后',\n          onClick (picker) {\n            const date = new Date();\n            date.setTime(date.getTime() + 3600 * 1000 * 24 * 7)\n            picker.$emit('pick', date);\n          }\n        }]\n      }\n    }\n  },\n  computed: {\n\n  },\n  watch: {\n    $route () {\n      if (this.$route.path === '/resources/sms/edit') {\n        this.initSmsTemplateList()\n        this.loadSendStatus()\n      }\n    }\n  },\n  mounted () {\n    //在vue的mount阶段执行的函数都是顺序执行，不会阻塞的，所以如果希望mount阶段的函数也是阻塞的，需要额外写一个async函数，然后把需要同步执行的函数写到里面，然后在mount阶段调用这个额外写的函数\n    this.initSmsTemplateList()\n    this.loadSendStatus()\n  },\n  methods: {\n    loadSendStatus () {\n      const type = this.$route.query.type\n      const id = this.$route.query.id\n      if (type === 'view') {\n        this.$refs.statusList.setTaskId(id)\n      }\n    },\n    async loadSmsTask () {\n      const type = this.$route.query.type\n      const id = this.$route.query.id\n      this.type = type\n      if (type) {// 切换到别的页面时，无需重置表单\n        // this.smsTask = this.initSmsTask()\n        this.reset()\n      }\n      if (type === 'view') {\n        this.disabled = true\n      } else {\n        this.disabled = false\n      }\n\n      if (id) {\n        await smsTaskApi.get(id)\n          .then(response => {\n            const res = response.data\n            this.smsTask = { ...this.smsTask, ...res.data }\n            if (type !== 'edit') {\n              this.smsTask.id = ''\n            }\n            this.changeTemplate(this.smsTask.templateId)\n            // this.telNumList = this.smsTask.telNum.split(\",\")\n            this.telNumList = this.smsTask.telNumList;\n\n            if (this.smsTask.templateParams) {\n              this.smsTask.templateParam = JSON.parse(this.smsTask.templateParams)\n            }\n            this.smsTask.content = res.data.content\n            console.log('查询')\n            if (this.smsTask.sendTime) {\n              this.timing = true\n            } else {\n              this.timing = false\n            }\n\n            this.smsTemplate = this.smsTemplateList.find(item => item.id === this.smsTask.templateId)\n\n          })\n      }\n    },\n    changeTemplate (id) {\n      const vm = this\n      // vm.preSearch()\n      if (id) {\n        //遍历模板添加文本框\n        for (const item of vm.smsTemplateList) {\n          if (item.id === id) {\n            let templateParam = {}\n            if (typeof (item.templateParams) == 'string') {\n              templateParam = JSON.parse(item.templateParams)\n            } else {\n              templateParam = item.templateParams\n            }\n\n            for (const prop in templateParam) {\n              templateParam[prop] = ''\n            }\n            vm.smsTemplate = item\n            if (vm.type !== 'view') {\n              console.log('赋值')\n              vm.smsTask.templateParam = templateParam\n              // vm.smsTask.content = item.content\n              this.content = item.content\n            }\n            break\n          }\n        }\n        vm.changeContent()\n      }\n    },\n    //模板文本框输入内容\n    templateCode (val, key) {\n      const vm = this\n      vm.smsTask.templateParam[key] = val\n      vm.changeContent()\n    },\n    //短信内容处理\n    changeContent () {\n      const vm = this\n      if (!vm.smsTemplate) {\n        return\n      }\n      const type = vm.smsTemplate.providerType.code\n      let content = vm.smsTemplate.content\n\n      for (const key in vm.smsTask.templateParam) {\n        let strs = ''\n        if (type == \"TENCENT\") {\n          strs = '{' + key + '}'\n        } else {\n          strs = '${' + key + '}'\n        }\n        if (vm.smsTask.templateParam[key]) {\n          content = content.replace(strs, vm.smsTask.templateParam[key])\n        }\n      }\n      if (vm.type !== 'view') {\n        console.log('赋值')\n        vm.smsTask.content = content\n      }\n    },\n    async initSmsTemplateList () {\n      await smsTemplateApi.page({ current: 1, size: 10000, model:{}})\n        .then(response => {\n          const res = response.data\n          if (res.isSuccess) {\n            this.smsTemplateList = res.data.records\n          }\n        })\n      await this.loadSmsTask()  // 顺序不能变\n    },\n    initSmsTask () {\n      return {\n        templateId: '',\n        topic: '',\n        templateParam: {},\n        sendTime: null,\n        content: '',\n        draft: false,\n        status: {\n          code: '',\n          desc: ''\n        }\n      }\n    },\n    reset () {\n      // 先清除校验，再清除表单，不然有奇怪的bug\n      this.$refs.form.clearValidate()\n      this.$refs.form.resetFields()\n      this.smsTask = this.initSmsTask()\n      this.telNumList = []\n    },\n    submitForm (draft) {\n      const vm = this\n      if (vm.smsTask.templateParam && Object.keys(vm.smsTask.templateParam).length > 0) {\n        let flag = false\n        for (const key in vm.smsTask.templateParam) {\n          if (!vm.smsTask.templateParam[key]) {\n            flag = true\n            break\n          }\n        }\n        if (flag) {\n          vm.$message({\n            message: '发送内容不能为空',\n            type: 'error'\n          })\n          return\n        }\n\n      } else {\n        vm.$message({\n          message: '发送内容不能为空',\n          type: 'error'\n        })\n        return\n      }\n\n      this.$refs.form.validate((valid) => {\n        if (valid) {\n          vm.editSubmit(draft)\n        } else {\n          return false\n        }\n      })\n    },\n    editSubmit (draft) {\n      const vm = this\n      vm.smsTask.draft = draft\n      vm.smsTask.telNum = vm.telNumList;\n      if (!vm.timing) {\n        vm.smsTask.sendTime = null\n      }\n      if (vm.type === 'edit') {\n        vm.update()\n      } else {\n        vm.save()\n      }\n    },\n    save () {\n      const vm = this\n      vm.disabled = true\n      smsTaskApi.save(vm.smsTask)\n        .then((response) => {\n          const res = response.data\n          if (res.isSuccess) {\n            vm.$message({\n              message: vm.$t('tips.createSuccess'),\n              type: 'success'\n            })\n            vm.reset()\n            vm.$router.push('/resources/sms')\n          }\n        }).finally(()=>{\n          vm.disabled = false})\n    },\n    update () {\n      const vm = this\n      vm.disabled = true\n      smsTaskApi.update(vm.smsTask)\n        .then((response) => {\n          const res = response.data\n          if (res.isSuccess) {\n            vm.$message({\n              message: vm.$t('tips.createSuccess'),\n              type: 'success'\n            })\n            vm.reset()\n            vm.$router.push('/resources/sms')\n          }\n        }).finally(()=>vm.disabled = false)\n    },\n    handleClose (tag) {\n      this.telNumList.splice(this.telNumList.indexOf(tag), 1)\n    },\n    showInput () {\n      this.telNumVisible = true\n      this.$nextTick(() => {\n        this.$refs.saveTagInput.$refs.input.focus()\n      });\n    },\n    handleInputConfirm () {\n      const vm = this\n      // 正则校验\n      let inputValue = vm.telNum\n      if (inputValue) {\n        if (!validMobile(inputValue)) {\n          this.$message({\n            message: '该手机号不合法',\n            type: 'error'\n          })\n          vm.$refs.saveTagInput.focus()\n          return\n        }\n\n        if (this.telNumList.indexOf(inputValue) === -1) {\n          vm.telNumList.push(inputValue)\n          vm.telNumVisible = false\n          vm.telNum = ''\n        } else {\n          this.$message({\n            message: '该账号已经存在',\n            type: 'error'\n          })\n          vm.$refs.saveTagInput.focus()\n        }\n      } else {\n        this.telNumVisible = false\n      }\n    }\n  }\n}\n",null]}